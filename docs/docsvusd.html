<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VIBE Protocol | Documentation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="icons/vibe.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  
  <style>
    /* Specific overrides for the Docs page */
    .doc-grid {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 30px;
    }
    @media (max-width: 900px) {
        .doc-grid { grid-template-columns: 1fr; }
        .doc-nav { display: none; }
    }

    .doc-nav {
        position: sticky;
        top: 20px;
        height: fit-content;
        background: rgba(0,0,0,0.2);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid var(--card-border);
    }

    .doc-nav a {
        display: block;
        padding: 8px 0;
        color: var(--text-muted);
        font-size: 0.9rem;
        transition: 0.2s;
    }
    .doc-nav a:hover, .doc-nav a.active {
        color: var(--success);
        padding-left: 5px;
    }

    .doc-section {
        margin-bottom: 50px;
        scroll-margin-top: 100px; /* Offset for sticky headers */
    }

    .method-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .method-name { color: var(--warning); font-family: monospace; font-weight: 600; margin-bottom: 5px; }
    .param-list { font-size: 0.85rem; color: var(--text-muted); margin-left: 10px; }
  </style>
</head>
<body>

  <div class="app-container">
    <!-- Sidebar -->
    <nav class="sidebar glass-panel">
      <div class="logo-area">
        <svg width="28" height="28" viewBox="0 0 64 64"><circle cx="32" cy="32" r="32" fill="#1a1f35"/><path d="M18 42 L32 18 L46 42 Z" fill="#00e0ff"/></svg>
        VIBE Finance
      </div>
      <a href="index.html" class="nav-link">Dashboard Home</a>
      <a href="dashboard.html" class="nav-link">Analytics & Pro</a>
      <a href="markets.html" class="nav-link">Markets Overview</a>
      <a href="mint-svusd.html" class="nav-link">Mint SVUSD</a>
      <a href="swapstabilizer.html" class="nav-link">Peg Stabilizer</a>
      
      <!-- Active Link -->
      <a href="#" class="nav-link active" style="color:#fff; border-left-color:#fff; background:rgba(255, 255, 255, 0.05);">Documentation</a>
      
      <div style="flex-grow:1"></div>
      <div style="padding: 10px; font-size: 0.8rem; color: var(--text-muted);">
        Connection Status:<br>
        <span id="statusDot" style="color: var(--danger)">‚óè</span> <span id="connStatus">Disconnected</span>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      
      <header>
        <div>
          <h1 style="margin:0; font-size:1.8rem;">Technical Docs</h1>
          <p style="margin:4px 0 0 0; color:var(--text-muted);">Architecture, Smart Contracts, and Mechanisms</p>
        </div>
        
        <div class="nav-group">
          <select id="networkSelect" class="network-select"><option value="" disabled selected>Loading...</option></select>
          <div class="btn-account-wrapper">
             <button id="btnConnect" class="btn-primary">Connect Wallet</button>
             <div id="accountDropdown" class="account-dropdown">
                 <div style="padding:12px 12px 6px 12px; font-size:0.8rem; color:var(--text-muted);">CONNECTED</div>
                 <div style="padding:0 12px 12px 12px; font-size:1.1rem; font-weight:600; color:#fff;" id="dropdownAddress">...</div>
                 <div class="menu-divider"></div>
                 <div class="menu-item" id="btnDisconnect" style="color:var(--danger);">Disconnect</div>
             </div>
          </div>
        </div>
      </header>

      <div class="doc-grid">
        
        <!-- Table of Contents -->
        <div class="doc-nav glass-panel">
            <h4 style="margin-top:0; color:#fff;">Contents</h4>
            <a href="#intro">1. Protocol Overview</a>
            <a href="#svusd">2. SVUSD Token</a>
            <a href="#stability">3. Stability Module (PSM)</a>
            <a href="#minting">4. Minting & Lending</a>
            <a href="#risk">5. Risk & Liquidations</a>
            <a href="#contracts">6. Contract Addresses</a>
        </div>

        <!-- Content Area -->
        <div class="glass-panel">
            
            <!-- SECTION 1 -->
            <div id="intro" class="doc-section">
                <h2 class="doc-header">1. Protocol Overview</h2>
                <p>VIBE Finance is a decentralized liquidity protocol built on Soneium. It allows users to lend assets to earn interest, borrowing against them, and mint the native stablecoin <strong>SVUSD</strong>.</p>
                <div class="doc-callout">
                    <strong>Core Architecture:</strong> The protocol utilizes a modified Comptroller system (`V_MasterEnhanced`) that integrates standard lending markets with specialized "Facilitators" for stablecoin issuance.
                </div>
            </div>

            <!-- SECTION 2 -->
            <div id="svusd" class="doc-section">
                <h2 class="doc-header">2. SVUSD Token</h2>
                <p>SVUSD (Sone Vibe USD) is an over-collateralized, dollar-pegged stablecoin. Unlike standard ERC20 tokens, SVUSD is controlled by a set of approved <strong>Facilitators</strong>.</p>
                <p>The token contract enforces a <strong>Bucket Capacity</strong> logic for each facilitator, limiting the maximum amount of SVUSD that specific contracts (like the Lending Market or Stability Module) can mint.</p>
                <ul class="doc-list">
                    <li><span class="code-tag">mint(to, amount)</span>: Only callable by active Facilitators within their bucket limits.</li>
                    <li><span class="code-tag">burn(from, amount)</span>: Facilitators can burn tokens to reduce supply (e.g., during repayment).</li>
                </ul>
            </div>

            <!-- SECTION 3 -->
            <div id="stability" class="doc-section">
                <h2 class="doc-header">3. Stability Module (PSM)</h2>
                <p>The Stability Module ensures the peg of SVUSD by allowing 1:1 swaps (minus fees) between SVUSD and a reserve asset (USDC).</p>
                
                <div class="method-card">
                    <div class="method-name">buySVUSD(uint256 amountUSDC)</div>
                    <div class="param-list">
                        Input: USDC (Reserve Asset)<br>
                        Output: Newly minted SVUSD<br>
                        Fee: Variable (Default 0.1%)
                    </div>
                </div>

                <div class="method-card">
                    <div class="method-name">sellSVUSD(uint256 amountSVUSD)</div>
                    <div class="param-list">
                        Input: SVUSD (Burned immediately)<br>
                        Output: USDC from Reserves<br>
                        Fee: Variable (Default 0.1%)
                    </div>
                </div>

                <p>This contract holds the USDC reserves directly. It has a <span class="code-tag">reserveCap</span> to limit risk exposure.</p>
            </div>

            <!-- SECTION 4 -->
            <div id="minting" class="doc-section">
                <h2 class="doc-header">4. Minting & Lending</h2>
                <p>Users can mint SVUSD by depositing collateral (ETH, WBTC, ASTR) into the protocol. This interaction is handled by the <strong>Mint Console</strong> logic.</p>
                
                <h3>The V_cSVUSD_Mintable Contract</h3>
                <p>This is a specialized market that acts as a bridge between the Comptroller and the SVUSD token.</p>
                <ul class="doc-list">
                    <li>When you <strong>Borrow</strong>, the contract calls <span class="code-tag">SVUSD.mint()</span> to your wallet.</li>
                    <li>When you <strong>Repay</strong>, the contract calls <span class="code-tag">SVUSD.burn()</span> to destroy the debt.</li>
                    <li><strong>Interest Rate:</strong> Debt accrues interest based on the <span class="code-tag">JumpRateModelSafe</span>. This interest does not go to suppliers (since there are none), but flows 100% to the protocol Treasury.</li>
                </ul>
            </div>

            <!-- SECTION 5 -->
            <div id="risk" class="doc-section">
                <h2 class="doc-header">5. Risk & Liquidations</h2>
                <p>The solvency of the system is maintained by the <strong>Comptroller (V_MasterEnhanced)</strong>.</p>
                
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Collateral Factor</td>
                            <td>The % of an asset's value that can be borrowed. E.g., 0.80 means you can borrow $80 for every $100 supplied.</td>
                        </tr>
                        <tr>
                            <td>Liquidation Threshold</td>
                            <td>The point at which a position becomes undercollateralized and subject to liquidation.</td>
                        </tr>
                        <tr>
                            <td>Liquidation Incentive</td>
                            <td>The discount liquidators receive when seizing collateral. Typically 5-10%.</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Liquidation Process</h3>
                <p>If a user's <span class="code-tag">Health Factor < 1.0</span>, anyone can call <span class="code-tag">liquidateBorrow()</span>.</p>
                <ol class="doc-list">
                    <li>Liquidator repays a portion of the user's SVUSD debt (burning it).</li>
                    <li>Liquidator seizes the user's collateral (e.g., cETH) at a discount.</li>
                    <li>The protocol solvency is restored.</li>
                </ol>
            </div>

            <!-- SECTION 6 -->
            <div id="contracts" class="doc-section">
                <h2 class="doc-header">6. Deployed Contracts (Minato Testnet)</h2>
                <table class="doc-table">
                    <thead>
                        <tr>
                            <th>Contract</th>
                            <th>Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><img src="icons/sonevibe.png" width="16" style="vertical-align:middle"> SVUSD Token</td>
                            <td><span class="code-tag">0x7960...2428</span></td>
                        </tr>
                        <tr>
                            <td>‚öñÔ∏è Stability Module</td>
                            <td><span class="code-tag">0x8A52...715d</span></td>
                        </tr>
                        <tr>
                            <td>üè≠ Mintable Market</td>
                            <td><span class="code-tag">0x2B55...3533</span></td>
                        </tr>
                        <tr>
                            <td>üß† Comptroller</td>
                            <td><span class="code-tag">0x8183...b24</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
      </div>

    </div> 
  </div>

  <!-- Wallet Modal -->
  <div id="walletModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header"><h2 class="modal-title">Connect Wallet</h2><button class="btn-close" onclick="closeWalletModal()">√ó</button></div>
      <div id="walletList" class="wallet-grid"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="config.js"></script>
  <script src="wallet-config.js"></script>
  
  <script>
    // Minimal Script for Docs Page (Only Connect Logic needed)
    let provider, signer, userAddress, NETWORKS_DATA, ACTIVE;
    let selectedProvider = null;
    const getEl = (id) => document.getElementById(id);

    // Reuse the exact same connection logic from mint-svusd.js
    const updateStatus = (state) => {
        const dot = getEl('statusDot');
        const txt = getEl('connStatus');
        const btn = getEl('btnConnect');
        
        if(state === 'syncing') {
            dot.style.color = "var(--warning)"; txt.textContent = "Syncing...";
            btn.textContent = "Connecting..."; btn.classList.remove('btn-connected');
        } else if(state === 'connected' && userAddress) {
            dot.style.color = "var(--success)"; txt.textContent = "Online";
            btn.textContent = userAddress.substring(0,6)+"..."+userAddress.substring(38);
            btn.classList.add('btn-connected');
            if(getEl('dropdownAddress')) getEl('dropdownAddress').textContent = userAddress;
        } else {
            dot.style.color = "var(--danger)"; txt.textContent = "Disconnected";
            btn.textContent = "Connect Wallet"; btn.classList.remove('btn-connected');
        }
    };

    document.addEventListener("DOMContentLoaded", async () => {
        NETWORKS_DATA = await window.loadNetworks();
        initNetworkSelector();
        initWalletUI();
        if(window.checkAutoConnect) await window.checkAutoConnect(connectWallet);
    });

    function initNetworkSelector() {
        const sel = getEl("networkSelect");
        sel.innerHTML = "";
        Object.values(NETWORKS_DATA).forEach(n => {
            if (n.enabled) {
                const opt = document.createElement("option");
                opt.value = n.chainId; opt.textContent = n.label;
                sel.appendChild(opt);
            }
        });
        sel.onchange = async (e) => { if(userAddress) await switchNetwork(e.target.value); };
    }

    function initWalletUI() {
        getEl("btnConnect").onclick = (e) => {
            e.stopPropagation();
            if(userAddress) getEl("accountDropdown").classList.toggle("show");
            else openWalletModal();
        };
        window.onclick = (e) => {
            if(e.target == getEl('walletModal')) closeWalletModal();
            if(!e.target.closest('#btnConnect')) getEl("accountDropdown").classList.remove("show");
        };
        getEl("btnDisconnect").onclick = () => {
            userAddress = null; updateStatus('disconnected'); window.location.reload();
        };
    }

    function openWalletModal() {
        const list = getEl('walletList'); list.innerHTML = '';
        window.WALLET_CONFIG.forEach(w => {
            const btn = document.createElement('div'); btn.className = 'wallet-btn';
            btn.innerHTML = `<div class="wallet-info"><img src="${w.icon}" width="32"><span>${w.name}</span></div>`;
            btn.onclick = () => { selectedProvider = w.getProvider(); closeWalletModal(); connectWallet(); };
            list.appendChild(btn);
        });
        getEl('walletModal').classList.add('open');
    }
    window.closeWalletModal = () => getEl('walletModal').classList.remove('open');

    async function connectWallet() {
        updateStatus('syncing');
        try {
            provider = new ethers.BrowserProvider(selectedProvider || window.ethereum);
            const acc = await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner();
            userAddress = acc[0];
            const net = await provider.getNetwork();
            ACTIVE = Object.values(NETWORKS_DATA).find(n => n.chainId == net.chainId);
            getEl("networkSelect").value = ACTIVE ? ACTIVE.chainId : "";
            updateStatus('connected');
        } catch(e) { console.error(e); updateStatus('disconnected'); }
    }
    
    async function switchNetwork(id) {
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: "0x"+Number(id).toString(16) }] }); } catch(e) {}
    }
  </script>
</body>
</html>
